<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Geo-Clue Fact Hunt - <%= courseId %></title>
  <script src='https://cdn.tailwindcss.com'></script>
  <link rel='stylesheet' href='../../../student/map_quiz/style.css'>
  <link rel='stylesheet' href='https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&display=swap'>
</head>
<body class="bg-darker-bg text-text-primary font-space-grotesk">

<%
  const sectionHeadings = [];
  const footerHeadings = [];
  if(modules && modules.length > 0){
    modules.forEach(m => {
      if(!sectionHeadings.includes(m.module_heading)) sectionHeadings.push(m.module_heading);
      if(!footerHeadings.includes(m.module_heading)) footerHeadings.push(m.module_heading);
    });
  }
  const formatId = str => str.toLowerCase().replace(/\s+/g,'-');
%>

<!-- Navbar -->
<nav id="navbar" class="fixed top-0 left-0 right-0 bg-gray-900/70 backdrop-blur-lg border-b border-[#FFFFFF]/30 z-50 transition-all duration-300">
  <div class="container flex items-center justify-between px-6 py-3">
    <div class="logo text-4xl font-bold text-white"><a href="/student/course/<%= courseId %>">MIP</a></div>
    <div class="hidden md:flex space-x-4">
      <% sectionHeadings.forEach(h => { %>
        <a href="/student/course/<%= courseId %>#<%= formatId(h) %>" class="nav-link text-white hover:text-[#7EA16B] px-4 py-2 rounded-md transition-colors duration-200"><%= h %></a>
      <% }) %>
    </div>
    <div class="md:hidden">
      <button id="mobile-menu-button" class="relative w-10 h-10 focus:outline-none">
        <span id="line1" class="block w-5 h-0.5 bg-[#7EA16B] mb-1 transition-transform duration-300"></span>
        <span id="line2" class="block w-5 h-0.5 bg-[#7EA16B] mb-1 transition-opacity duration-300"></span>
        <span id="line3" class="block w-5 h-0.5 bg-[#7EA16B] transition-transform duration-300"></span>
      </button>
    </div>
  </div>
  <div id="mobile-menu" class="md:hidden overflow-hidden max-h-0 transition-all duration-300 px-6">
    <div class="flex flex-col pt-2 pb-4 space-y-1">
      <% sectionHeadings.forEach(h => { %>
        <a href="/student/course/<%= courseId %>#<%= formatId(h) %>" class="mobile-nav-link block text-white hover:text-[#7EA16B] hover:bg-gray-800/50 px-4 py-2 rounded-md transition-colors duration-200"><%= h %></a>
      <% }) %>
    </div>
  </div>
</nav>

<!-- Main Quiz Section -->
<main class="pt-24">
  <section class="py-6">
    <div class="container mx-auto px-4">
      <div id="map-quiz" class="max-w-5xl mx-auto bg-gray-900/70 border border-[#7EA16B]/20 p-8 rounded-2xl shadow-2xl text-center">
        <h2 class="text-2xl font-semibold text-[#7EA16B] mb-2">Clue Quiz</h2>
        <p id="map-quiz-clue" class="text-white mb-4">Click ‚ÄúStart Quiz‚Äù to begin!</p>
        <input id="map-quiz-guess" type="text" placeholder="Your guess here‚Ä¶" class="form-input mb-4 w-full p-3 rounded-lg border border-[#7EA16B] bg-gray-800 text-white">
        <div class="mb-4 flex justify-center gap-2">
<button id="map-quiz-start" class="bg-[#7EA16B] text-white px-4 py-2 rounded-lg hover:bg-[#617d52] transition-colors">Start Quiz</button>
          <button id="map-quiz-submit" class="btn btn-outline" style="display:none;">Submit Guess</button>
        </div>
        <p id="map-quiz-result" class="text-white mb-2"></p>
        <p id="map-quiz-score" class="text-[#7EA16B] font-semibold mb-1">Score: 20</p>
        <p id="map-quiz-tries" class="text-gray-400">Attempts left: ‚Äî</p>
                  <div class="mt-6 flex justify-between text-sm text-darkgray-500">
              <a href="/student/course/<%= courseId%>" class="hover:text-[#7EA16B] transition-colors">‚Üê Go back</a>
          </div>

      </div>
    <iframe id="geemap-frame" src="../../../module/7.html" class="w-full h-[700px] my-5 py-0 border-0 rounded-xl shadow-lg"></iframe>
    </div>
  </section>
</main>

<!-- Footer -->
<footer class="bg-black/60 border-t border-gray-800">
  <div class="container mx-auto px-12 py-12 flex flex-col md:flex-row justify-between items-center">
    <div class="flex items-center mb-4 md:mb-0">
      <div class="font-bold text-3xl mr-2 text-white">MIP</div>
      <div class="text-xl font-medium text-gray-300">The GIST</div>
    </div>
    <div class="flex flex-wrap justify-center mb-4 md:mb-0">
      <% footerHeadings.forEach(h => { %>
        <a href="/student/course/<%= courseId %>#<%= formatId(h) %>" class="text-gray-400 hover:text-[#7EA16B] mx-2 transition-colors duration-200"><%= h %></a>
      <% }) %>
    </div>
  </div>
</footer>
<div class="text-center text-gray-500 text-sm py-4 bg-black/60">
  ¬© 2025 MIP (Geo-Clue Fact Hunt). All rights reserved.
</div>

<script>
  const boatQuestions = <%- JSON.stringify(boatQuestions) %>;

  let currentIndex = 0;
  let currentClueIndex = 0;
  let attempts = 3;
  let roundPoints = 20;
  let totalScore = 0;
  let locked = false;

  const clueEl = document.getElementById("map-quiz-clue");
  const guessEl = document.getElementById("map-quiz-guess");
  const resultEl = document.getElementById("map-quiz-result");
  const scoreEl = document.getElementById("map-quiz-score");
  const triesEl = document.getElementById("map-quiz-tries");
  const startBtn = document.getElementById("map-quiz-start");
  const submitBtn = document.getElementById("map-quiz-submit");

  function shuffle(arr) { for (let i=arr.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[arr[i],arr[j]]=[arr[j],arr[i]];}return arr; }
  function startQuiz(){ shuffle(boatQuestions); currentIndex=0; totalScore=0; startQuestion(); startBtn.style.display="none"; submitBtn.style.display="inline-block"; }
  function startQuestion(){ 
    if(currentIndex>=boatQuestions.length)return endQuiz(); 
    locked=false; currentClueIndex=0; attempts=3; roundPoints=20; 
    const q=boatQuestions[currentIndex]; 
    clueEl.innerText=`Clue 1: ${q.clues[currentClueIndex]||""}`; 
    resultEl.innerText=""; guessEl.value=""; guessEl.disabled=false; submitBtn.disabled=false; 
    scoreEl.innerText=`Score: ${roundPoints}`; triesEl.innerText=`Attempts left: ${attempts}`;
  }
  function submitGuess(){
    if(locked)return;
    const q=boatQuestions[currentIndex];
    const guess=guessEl.value.trim().toLowerCase();
    if(!guess)return;
    if(guess===q.answer.toLowerCase()){
      totalScore+=roundPoints; resultEl.innerText=`‚úÖ Correct! It was ${q.answer}. (+${roundPoints} pts)`; 
      scoreEl.innerText=`Total Score: ${totalScore}`; lockInput(); nextQuestion();
    } else {
      attempts--; 
      if(attempts>0){ resultEl.innerText=`‚ùå Incorrect. Try again! (${attempts} left)`; triesEl.innerText=`Attempts left: ${attempts}`; }
      else{ currentClueIndex++; if(currentClueIndex<q.clues.length){ roundPoints=Math.max(0,roundPoints-5); attempts=3;
        clueEl.innerText=`Clue ${currentClueIndex+1}: ${q.clues[currentClueIndex]}`;
        resultEl.innerText=`üí° Another clue! (-5 points)`; scoreEl.innerText=`Score: ${roundPoints}`; triesEl.innerText=`Attempts left: ${attempts}`;
        if(roundPoints<=0) revealAnswer(q);
      } else revealAnswer(q); }
    }
  }
  function revealAnswer(q){ roundPoints=0; scoreEl.innerText=`Score: ${roundPoints}`; resultEl.innerText=`üìò Out of points! The correct answer was ${q.answer}.`; lockInput(); nextQuestion(); }
  function lockInput(){ locked=true; guessEl.disabled=true; submitBtn.disabled=true; }
  function nextQuestion(){ setTimeout(()=>{ currentIndex++; if(currentIndex<boatQuestions.length) startQuestion(); else endQuiz(); },2000); }
  function endQuiz(){ clueEl.innerText=`üéâ Quiz complete! Your final score: ${totalScore} points.`; submitBtn.style.display="none"; startBtn.style.display="inline-block"; startBtn.innerText="Restart Quiz"; triesEl.innerText=`Attempts left: ‚Äî`; guessEl.disabled=true; }

  startBtn.addEventListener("click", startQuiz);
  submitBtn.addEventListener("click", submitGuess);

  // Mobile menu toggle
  const menuBtn = document.getElementById("mobile-menu-button");
  const mobileMenu = document.getElementById("mobile-menu");
  menuBtn.addEventListener("click", ()=>{
    menuBtn.classList.toggle("active");
    mobileMenu.classList.toggle("open");
  });
</script>

</body>
</html>
